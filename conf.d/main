#!/bin/bash -ex
DB_NAME=phoenix_cart
DB_USER=phoenix_cart
DB_PASS=$(mcookie)

ADMIN_NAME="admin"
ADMIN_PASS="turnkey"
ADMIN_MAIL="admin@example.com"

WEBROOT=/var/www/phoenix_cart

# unpack and set permissions
cd "$(dirname "$WEBROOT")"
git clone "https://github.com/CE-PhoenixCart/PhoenixCart" phoenix_cart

# configure apache
a2dissite 000-default

a2ensite phoenix_cart
a2enmod headers
a2enmod rewrite

# temporarily disable rewrite rules
sed -i 's/\(RewriteRule.*\)/#\1/' /etc/apache2/sites-available/phoenix_cart.conf

# start services
service mysql start
service apache2 start

# setup the database
MYSQL_BATCH="mysql --user=root --password=$MYSQL_PASS --batch"
MYSQL_ADMIN="mysqladmin --user=root --password=$MYSQL_PASS"

$MYSQL_ADMIN create $DB_NAME
$MYSQL_BATCH --execute "grant all privileges on $DB_NAME.* to $DB_USER@localhost identified by '$DB_PASS'; flush privileges;"

chown -R www-data:www-data "$WEBROOT"

# curl based install
EMAIL=$(echo $ADMIN_MAIL | sed s/@/%40/)

CURL="curl --insecure -L -c /tmp/cookie -b /tmp/cookie"

unset HTTP_PROXY HTTPS_PROXY http_proxy https_proxy

do_step() {
    url="$1"
    data="$2"
    $CURL -k "$url" -X POST --data-raw "$2"
    sleep 1
}

chown -R www-data:www-data "$WEBROOT"
curl -k -L 'https://localhost/install/rpc.php'\
'?action=dbCheck'\
'&server=localhost'\
'&username='"$DB_USER"''\
'&password='"$DB_PASS"''\
'&name='"$DB_NAME"

curl -k -L 'https://localhost/install/rpc.php'\
'?action=dbImport'\
'&server=localhost'\
'&username='"$DB_USER"''\
'&password='"$DB_PASS"''\
'&name='"$DB_NAME"''\
'&importsample=1'

do_step 'https://localhost/install/install.php?step=2' \
'DB_SERVER=localhost'\
'&DB_SERVER_USERNAME='"$DB_USER"''\
'&DB_SERVER_PASSWORD='"$DB_PASS"''\
'&DB_DATABASE='"$DB_NAME"''\
'&DB_IMPORT_SAMPLE=1'

do_step 'https://localhost/install/install.php?step=3' \
'HTTP_WWW_ADDRESS=https%3A%2F%2Fwww.example.net%2F'\
'&DIR_FS_DOCUMENT_ROOT=%2Fvar%2Fwww%2Fphoenix_cart%2F'\
'&DB_SERVER=localhost'\
'&DB_SERVER_USERNAME='"$DB_USER"''\
'&DB_SERVER_PASSWORD='"$DB_PASS"''\
'&DB_DATABASE='"$DB_NAME"''\
'&DB_IMPORT_SAMPLE=1'

do_step 'https://localhost/install/install.php?step=4' \
'CFG_STORE_NAME=Turnkey+PhoenixCart'\
'&CFG_STORE_OWNER_NAME=John+Doe'\
'&CFG_STORE_OWNER_EMAIL_ADDRESS='"$EMAIL"''\
'&CFG_ADMINISTRATOR_USERNAME='"$ADMIN_NAME"''\
'&CFG_ADMINISTRATOR_PASSWORD='"$ADMIN_PASS"''\
'&CFG_ADMIN_DIRECTORY=administration'\
'&CFG_TIME_ZONE=UTC'\
'&HTTP_WWW_ADDRESS=https%3A%2F%2Fwww.example.net%2F'\
'&DIR_FS_DOCUMENT_ROOT=%2Fvar%2Fwww%2Fphoenix_cart%2F'\
'&DB_SERVER=localhost'\
'&DB_SERVER_USERNAME='"$DB_USER"''\
'&DB_SERVER_PASSWORD='"$DB_PASS"''\
'&DB_DATABASE='"$DB_NAME"''\
'&DB_IMPORT_SAMPLE=1'

rm -rf $WEBROOT/install
rm -f /tmp/cookie

rm -r "$WEBROOT/.github"

# stop services
service mysql stop
service apache2 stop

rm /etc/apache2/sites-enabled/phoenix_cart.conf
ln -s /etc/apache2/sites-{available,enabled}/phoenix_cart.conf

sed -i 's/#\(RewriteRule.*\)/\1/' /etc/apache2/sites-available/phoenix_cart.conf
